Bootstrap: localimage 
From: ubuntu-rocm.sif
%post
	apt install -y python3-venv
	python3 -m pip install --prefix=/usr --force-reinstall --upgrade --no-cache-dir tensorflow-rocm
	
	export HOROVOD_WITHOUT_MXNET=1
	export HOROVOD_WITHOUT_PYTORCH=1
	export HOROVOD_GPU=ROCM
	export HOROVOD_GPU_OPERATIONS=NCCL
	export HOROVOD_WITHOUT_GLOO=1
	export HOROVOD_WITH_TENSORFLOW=1
	export HOROVOD_ROCM_PATH=/opt/rocm
	export HOROVOD_RCCL_HOME=/opt/rocm/rccl
	export RCCL_INCLUDE_DIRS=/opt/rocm/rccl/include
	export HOROVOD_RCCL_LIB=/opt/rocm/rccl/lib
	export HCC_AMDGPU_TARGET=gfx90a
	python3 -m pip install --prefix=/usr --force-reinstall --upgrade --no-cache-dir "horovod==0.28.1"

%environment
	export NCCL_DEBUG=INFO
	export NCCL_SOCKET_IFNAME=hsn
	export CXI_FORK_SAFE=1
	export CXI_FORK_SAFE_HP=1
	export FI_CXI_DISABLE_CQ_HUGETLB=1
